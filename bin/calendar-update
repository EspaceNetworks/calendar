#!/usr/bin/php -q
<?php
if (!@include_once(getenv('FREEPBX_CONF') ? getenv('FREEPBX_CONF') : '/etc/freepbx.conf')) {
	include_once('/etc/asterisk/freepbx.conf');
}
/**
 * TODO: Sync External calendars - Later
 * TODO: Process Presence events. - Release
 */
$cal = FreePBX::Calendar();
$dpevents = $cal->listEvents(date('Y-m-d'),date('Y-m-d'),'',array('type' => 'type', 'data' => 'dialplan'));
$astman = FreePBX::create()->astman;
$presenceevents = $cal->listEvents(date('Y-m-d'),date('Y-m-d'),'',array('type' => 'type', 'data' => 'presence'));
//Clear events
$astman->database_deltree("CALENDAREVENT");
foreach ($dpevents as $id => $event) {
	//Set Hint
	if(isset($event['generatehint']) && $event['generatehint'] == '1'){
		$status = ($cal->checkEvent($event))?'INUSE':'NOT_INUSE';
		$astman->send_request('Command',array('Command'=>"devstate change Custom:CALENDAR".$id." ".$status));
	}
}
